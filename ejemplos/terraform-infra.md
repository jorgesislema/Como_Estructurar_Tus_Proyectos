# Ejemplo: Infraestructura como C√≥digo (IaC) con Terraform

¬°Bienvenido/a a la plantilla de ejemplo para gestionar tu infraestructura usando Terraform! La Infraestructura como C√≥digo (IaC) te permite definir y aprovisionar tu infraestructura (servidores, bases de datos, redes, etc.) mediante c√≥digo, lo que aporta **automatizaci√≥n, consistencia, control de versiones y colaboraci√≥n** al proceso.

Este ejemplo se centra en estructurar un proyecto Terraform para manejar **m√∫ltiples entornos** (ej: desarrollo, staging, producci√≥n) de forma segura y escalable, utilizando **m√≥dulos reutilizables** y **estado remoto**.

## Objetivo üéØ

* Mostrar una **estructura organizada y escalable** para proyectos Terraform multi-entorno.
* Fomentar el uso de **m√≥dulos** para la reutilizaci√≥n y abstracci√≥n del c√≥digo.
* Destacar la importancia del **estado remoto y el bloqueo de estado** para el trabajo en equipo.
* Proveer un **punto de partida pr√°ctico** para gestionar tu infraestructura real.

## Tecnolog√≠as y Conceptos Clave üèóÔ∏è

* **Terraform:** La herramienta principal para definir y aplicar la IaC.
* **M√≥dulos Terraform:** Bloques de c√≥digo reutilizables que encapsulan un conjunto de recursos relacionados (ej: una VPC, una instancia EC2).
* **Entornos Separados:** Estructura de directorios para aislar la configuraci√≥n y el estado de cada entorno (dev, staging, prod).
* **Estado Remoto (Remote State):** Almacenar el archivo de estado de Terraform (`terraform.tfstate`) en un backend remoto y compartido (como AWS S3 con bloqueo en DynamoDB, Azure Storage, Google Cloud Storage, Terraform Cloud/Enterprise) en lugar de localmente. ¬°Esencial para la colaboraci√≥n y la seguridad!
* **Bloqueo de Estado (State Locking):** Mecanismo (usualmente provisto por el backend remoto) que previene que m√∫ltiples usuarios apliquen cambios concurrentemente al mismo estado, evitando corrupci√≥n.
* **Variables y Salidas:** Parameterizar la infraestructura y exponer informaci√≥n √∫til.
* **(Opcional) Herramientas de Calidad/Seguridad:** `terraform fmt` (incluido), [TFLint](https://github.com/terraform-linters/tflint) (linter), [tfsec](https://github.com/aquasecurity/tfsec) o [Checkov](https://github.com/bridgecrewio/checkov) (esc√°neres de seguridad).

## Estructura del Directorio üó∫Ô∏è

* **`environments/`**: Contiene la configuraci√≥n espec√≠fica para cada entorno de despliegue.
    * **`<environment_name>/`** (ej: `dev`, `staging`, `prod`): Cada subdirectorio representa un entorno aislado. Contiene su propia configuraci√≥n de `backend.tf` (apuntando a un *estado remoto diferente*), `providers.tf`, y un `main.tf` que orquesta la creaci√≥n de infraestructura *llamando a los m√≥dulos reutilizables*. Los valores espec√≠ficos del entorno se definen en `terraform.tfvars` (¬°cuidado con los secretos!).
    * **`_shared/`**: (Opcional) Para definir variables o configuraciones comunes a todos los entornos, aunque es preferible pasar todo a trav√©s de variables a los m√≥dulos.
* **`modules/`**: Contiene m√≥dulos Terraform locales reutilizables. Cada m√≥dulo es una unidad autocontenida que define un conjunto l√≥gico de recursos (ej: `network`, `compute`, `database`).
    * **`<module_name>/`**: Cada subdirectorio es un m√≥dulo con sus propios `main.tf`, `variables.tf`, y `outputs.tf`. Un buen m√≥dulo tiene un `README.md` explicando c√≥mo usarlo.
* **Archivos Ra√≠z:** Configuraciones globales de herramientas (linters, gitignore), este `README.md`.

## Archivos y Conceptos Clave Detallados ‚ú®

* **`environments/<env>/backend.tf`:** ¬°Fundamental! Configura d√≥nde se almacenar√° el estado de *este entorno espec√≠fico*. **Cada entorno DEBE tener su propio archivo de estado remoto aislado** para evitar que cambios en `dev` afecten a `prod`. El backend elegido (ej: S3) debe soportar **bloqueo de estado** (ej: usando DynamoDB con S3).
* **`modules/<module>/`:** La clave de la reutilizaci√≥n. Permiten abstraer la complejidad. Puedes usar m√≥dulos locales (dentro de esta carpeta) o m√≥dulos externos (del [Registro de Terraform](https://registry.terraform.io/), GitHub, etc.). Se llaman desde los `main.tf` de los entornos.
* **`environments/<env>/main.tf`:** No define recursos directamente (o muy pocos). Su funci√≥n principal es **llamar a los m√≥dulos** definidos en `modules/` o externos, pas√°ndoles las variables necesarias para ese entorno. Compone la infraestructura a partir de bloques reutilizables.
* **`variables.tf` / `terraform.tfvars`:** Definen las entradas para cada entorno o m√≥dulo. `terraform.tfvars` es la forma est√°ndar de pasar valores, pero **NUNCA commitees secretos** (API keys, contrase√±as) en √©l. Usa variables de entorno (`TF_VAR_nombre_variable`), un archivo `.tfvars` separado y gitignoreado, o herramientas de gesti√≥n de secretos (HashiCorp Vault, AWS Secrets Manager, etc.).
* **`providers.tf`:** Configura los proveedores de nube (AWS, Azure, GCP...) indicando regi√≥n, versi√≥n, y potentially credenciales (aunque es mejor manejar credenciales fuera del c√≥digo, ej: variables de entorno, perfiles IAM/CLI).

## C√≥mo Usar esta Plantilla üöÄ

1.  **Prerrequisitos:**
    * [Terraform CLI](https://developer.hashicorp.com/terraform/downloads) instalado.
    * Cuenta en un proveedor de nube (ej: AWS, Azure, GCP).
    * Credenciales del proveedor configuradas de forma segura para que Terraform las use (ej: variables de entorno `AWS_ACCESS_KEY_ID`/`AWS_SECRET_ACCESS_KEY`, perfil `aws configure`, etc.).
2.  **Clonar:** `git clone <URL_DEL_REPO_UNIVERSAL> && cd ejemplos/terraform-infra`
3.  **Configurar el Backend Remoto:** **¬°Paso Manual Inicial!** Antes de ejecutar `terraform init` por primera vez en un entorno, necesitas crear manualmente los recursos para el backend remoto (ej: el bucket S3 y la tabla DynamoDB especificados en `environments/<env>/backend.tf`). Aseg√∫rate de que los nombres sean √∫nicos por entorno.
4.  **Navegar al Entorno:** Elige un entorno para trabajar.
    ```bash
    cd environments/dev
    ```
5.  **Inicializar Terraform:** Descarga los providers y configura el backend remoto.
    ```bash
    terraform init
    ```
6.  **(Opcional) Planificar Cambios:** Revisa qu√© acciones ejecutar√° Terraform. Pasa variables mediante un archivo `.tfvars` (si no contiene secretos) o variables de entorno.
    ```bash
    # Opci√≥n 1: Usando un archivo .tfvars (¬°aseg√∫rate que est√° en .gitignore si tiene secretos!)
    terraform plan -var-file="terraform.tfvars"

    # Opci√≥n 2: Usando variables de entorno (para secretos)
    # export TF_VAR_db_password="mi_secreto"
    # terraform plan
    ```
7.  **Aplicar Cambios:** Crea o actualiza la infraestructura. Se te pedir√° confirmaci√≥n.
    ```bash
    # Opci√≥n 1: Con .tfvars
    terraform apply -var-file="terraform.tfvars"

    # Opci√≥n 2: Con env vars
    # terraform apply
    ```
8.  **Destruir Infraestructura:** Elimina los recursos gestionados por Terraform en este entorno. ¬°Ten cuidado!
    ```bash
    # Opci√≥n 1: Con .tfvars
    terraform destroy -var-file="terraform.tfvars"

    # Opci√≥n 2: Con env vars
    # terraform destroy
    ```

## Flujo de Trabajo T√≠pico üîÑ

1.  Crea una nueva rama en Git (`git checkout -b feature/nueva-infra`).
2.  Realiza cambios en los m√≥dulos (`modules/`) o en la configuraci√≥n de un entorno (`environments/<env>/`).
3.  Navega al directorio del entorno afectado (`cd environments/<env>`).
4.  Ejecuta `terraform fmt -recursive ../../` para formatear.
5.  Ejecuta `terraform validate` para chequear sintaxis.
6.  Ejecuta `terraform plan` para revisar los cambios.
7.  (En un entorno de CI/CD) El plan se revisa y aprueba mediante un Pull Request.
8.  (En un entorno de CI/CD o manualmente) Ejecuta `terraform apply` para aplicar los cambios al entorno correspondiente.

## Alternativas (Menci√≥n Breve) ü§î

* **Terraform Workspaces:** Permiten gestionar m√∫ltiples estados dentro de un mismo directorio de configuraci√≥n y backend. √ötil para variaciones menores, pero la separaci√≥n por directorios suele ser m√°s clara para entornos fundamentalmente distintos.
* **Terragrunt:** Una herramienta wrapper sobre Terraform que ayuda a mantener el c√≥digo DRY (Don't Repeat Yourself) al gestionar m√∫ltiples m√≥dulos y entornos, reduciendo la duplicaci√≥n en archivos `backend.tf` y `providers.tf`. A√±ade otra capa de abstracci√≥n.

## Siguientes Pasos y Adaptaci√≥n üë£

* **Adapta los M√≥dulos:** Crea o modifica los m√≥dulos en `modules/` seg√∫n tu infraestructura real.
* **Configura tu Backend:** Cambia la configuraci√≥n en `backend.tf` para usar tu bucket S3, Terraform Cloud, Azure Storage, etc.
* **Gestiona Secretos:** Implementa una estrategia segura para las variables sensibles (Vault, AWS Secrets Manager, Azure Key Vault, GCP Secret Manager, variables de entorno en CI/CD). **¬°No commitees secretos en `.tfvars`!**
* **Integra CI/CD:** Configura GitHub Actions, GitLab CI, Jenkins, etc., para automatizar `plan` y `apply` en tus entornos.
* **A√±ade Pruebas y Validaci√≥n:** Integra `tflint`, `tfsec`/`checkov` en tus pre-commit hooks o CI para mejorar la calidad y seguridad. Considera herramientas de testing como Terratest.

## Contribuciones a este Ejemplo ‚ú®

Las mejoras a *esta plantilla espec√≠fica de Terraform* son bienvenidas. Sigue la gu√≠a general (`comunidad/como-contribuir.md`) indicando que tu aporte es para `ejemplos/terraform-infra`.

¬°Esperamos que esta estructura te sirva como una base s√≥lida y escalable para gestionar tu infraestructura como c√≥digo con Terraform! ‚òÅÔ∏è‚öôÔ∏è


```bash 

ejemplos/terraform-infra/
‚îú‚îÄ‚îÄ .gitignore                  # Ignorar .terraform/, *.tfstate, *.tfstate.*, crash.log, *.tfvars (si contienen secretos)
‚îú‚îÄ‚îÄ .tflint.hcl                 # (Opcional) Configuraci√≥n para TFLint
‚îú‚îÄ‚îÄ .terraform-docs.yml         # (Opcional) Configuraci√≥n para terraform-docs
‚îú‚îÄ‚îÄ README.md                   # Este archivo: explicaci√≥n del ejemplo
‚îú‚îÄ‚îÄ environments/               # Directorio ra√≠z para las configuraciones por entorno
‚îÇ   ‚îú‚îÄ‚îÄ _shared/                # (Opcional) Archivos comunes o variables compartidas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shared_vars.tf
‚îÇ   ‚îú‚îÄ‚îÄ dev/                    # Configuraci√≥n espec√≠fica para el entorno DEV
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ backend.tf          # Configuraci√≥n del backend de estado remoto para DEV
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf             # Orquestaci√≥n principal: Llama a los m√≥dulos para DEV
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf          # Salidas del entorno DEV
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ providers.tf        # Configuraci√≥n de providers (ej: regi√≥n AWS) para DEV
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars    # **¬°IGNORAR EN GIT SI CONTIENE SECRETOS!** Valores para DEV
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ variables.tf        # Variables de entrada para el entorno DEV
‚îÇ   ‚îú‚îÄ‚îÄ staging/                # Configuraci√≥n espec√≠fica para el entorno STAGING
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ backend.tf          # Backend de estado remoto para STAGING (¬°DIFERENTE!)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ providers.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars    # **¬°IGNORAR EN GIT SI CONTIENE SECRETOS!**
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ variables.tf
‚îÇ   ‚îî‚îÄ‚îÄ prod/                   # Configuraci√≥n espec√≠fica para el entorno PROD
‚îÇ       ‚îú‚îÄ‚îÄ backend.tf          # Backend de estado remoto para PROD (¬°DIFERENTE!)
‚îÇ       ‚îú‚îÄ‚îÄ main.tf
‚îÇ       ‚îú‚îÄ‚îÄ outputs.tf
‚îÇ       ‚îú‚îÄ‚îÄ providers.tf
‚îÇ       ‚îú‚îÄ‚îÄ terraform.tfvars    # **¬°IGNORAR EN GIT SI CONTIENE SECRETOS!**
‚îÇ       ‚îî‚îÄ‚îÄ variables.tf
‚îî‚îÄ‚îÄ modules/                    # M√≥dulos Terraform reutilizables locales
    ‚îú‚îÄ‚îÄ network/                # Ejemplo: M√≥dulo para crear una VPC, subnets, etc.
    ‚îÇ   ‚îú‚îÄ‚îÄ main.tf             # Recursos del m√≥dulo (aws_vpc, aws_subnet...)
    ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf          # Salidas del m√≥dulo (vpc_id, subnet_ids...)
    ‚îÇ   ‚îú‚îÄ‚îÄ README.md           # Documentaci√≥n del m√≥dulo
    ‚îÇ   ‚îî‚îÄ‚îÄ variables.tf        # Variables de entrada del m√≥dulo (cidr_block, etc.)
    ‚îú‚îÄ‚îÄ compute/                # Ejemplo: M√≥dulo para crear instancias EC2, ASG, etc.
    ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
    ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf
    ‚îÇ   ‚îú‚îÄ‚îÄ README.md
    ‚îÇ   ‚îî‚îÄ‚îÄ variables.tf
    ‚îî‚îÄ‚îÄ database/               # Ejemplo: M√≥dulo para crear una base de datos RDS
        ‚îú‚îÄ‚îÄ main.tf
        ‚îú‚îÄ‚îÄ outputs.tf
        ‚îú‚îÄ‚îÄ README.md
        ‚îî‚îÄ‚îÄ variables.tf
```